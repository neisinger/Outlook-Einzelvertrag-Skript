Option Explicit

Sub VertragErinnerungNachverfolgung()
    ' Deklariere Variablen
    Dim olApp As Outlook.Application
    Dim olNamespace As Outlook.NameSpace
    Dim VertragswesenFolder As Outlook.Folder
    Dim NachverfolgungFolder As Outlook.Folder
    Dim AbgeschlossenFolder As Outlook.Folder
    Dim olInbox As Outlook.Folder
    Dim olMail As Outlook.MailItem
    Dim replyMail As Outlook.MailItem
    Dim antwortVorhanden As Boolean
    Dim ReminderMail As Outlook.MailItem
    Dim PersonenMitAntwort As String
    Dim PersonenMitErinnerung As String
    Dim Item As Object
    Dim Reply As Object
    Dim dtToday As Date
    Dim DaysToWait As Integer
    Dim ZusammenfassungMail As Outlook.MailItem
    Dim ItemsToProcess As Collection
    Dim i As Integer
    Dim recipientAddress As String
    
    ' Konfigurierbare Variablen
    Const VERTRAGSWESEN_ORDNER As String = "Vertragswesen"
    Const NACHVERFOLGUNG_ORDNER_NAME As String = "Nachverfolgung"
    Const ABGESCHLOSSEN_ORDNER_NAME As String = "Abgeschlossen"
    Const ZUSAMMENFASSUNG_EMPFAENGER As String = "deine.email@beispiel.de"
    
    ' Anzahl der Tage, nach denen eine Erinnerung gesendet wird
    DaysToWait = 7 ' Anpassbar: Standard ist 7 Tage
    dtToday = Date
 
    ' Fehlerbehandlung aktivieren
    On Error GoTo ErrorHandler
    
    ' Initialisiere Outlook-Objekte
    Set olApp = Outlook.Application
    Set olNamespace = olApp.GetNamespace("MAPI")
 
    ' Hole die Zielordner mit verbesserter Fehlerbehandlung
    On Error Resume Next
    Set VertragswesenFolder = olNamespace.GetDefaultFolder(olFolderInbox).Folders(VERTRAGSWESEN_ORDNER)
    If VertragswesenFolder Is Nothing Then
        On Error GoTo ErrorHandler
        MsgBox "Fehler: Der Ordner '" & VERTRAGSWESEN_ORDNER & "' wurde nicht gefunden. Bitte erstellen Sie die erforderliche Ordnerstruktur.", vbCritical
        Exit Sub
    End If
    
    Set NachverfolgungFolder = VertragswesenFolder.Folders(NACHVERFOLGUNG_ORDNER_NAME)
    Set AbgeschlossenFolder = VertragswesenFolder.Folders(ABGESCHLOSSEN_ORDNER_NAME)
    On Error GoTo ErrorHandler
    
    ' Überprüfe, ob die Ordner existieren
    If NachverfolgungFolder Is Nothing Then
        MsgBox "Fehler: Der Ordner '" & VERTRAGSWESEN_ORDNER & "/" & NACHVERFOLGUNG_ORDNER_NAME & "' wurde nicht gefunden.", vbCritical
        Exit Sub
    End If
    
    If AbgeschlossenFolder Is Nothing Then
        MsgBox "Fehler: Der Ordner '" & VERTRAGSWESEN_ORDNER & "/" & ABGESCHLOSSEN_ORDNER_NAME & "' wurde nicht gefunden.", vbCritical
        Exit Sub
    End If
    
    Set olInbox = olNamespace.GetDefaultFolder(olFolderInbox)
 
    ' Initialisiere Zusammenfassungs-Strings
    PersonenMitAntwort = "Personen, die geantwortet haben:" & vbCrLf
    PersonenMitErinnerung = "Personen, die eine Erinnerung erhalten haben:" & vbCrLf
 
    ' Sammle E-Mails, die bearbeitet werden müssen (verhindert Iteration über sich ändernde Collection)
    Set ItemsToProcess = New Collection
    For Each Item In NachverfolgungFolder.Items
        If TypeName(Item) = "MailItem" Then
            Set olMail = Item
            ' Prüfe, ob die E-Mail älter als die festgelegte Anzahl von Tagen ist
            If olMail.ReceivedTime <= DateAdd("d", -DaysToWait, dtToday) Then
                ItemsToProcess.Add olMail
            End If
        End If
    Next Item
 
    ' Überprüfe gesammelte E-Mails
    For i = 1 To ItemsToProcess.Count
        Set olMail = ItemsToProcess(i)
        antwortVorhanden = False
        Dim recipientAddress As String
        recipientAddress = olMail.To ' Speichere Empfänger vor dem Verschieben
 
        ' Suche im Posteingang nach Antworten
        For Each Reply In olInbox.Items
            If TypeName(Reply) = "MailItem" Then
                Set replyMail = Reply
                ' Prüfe, ob eine Antwort vorliegt (bessere Subject-Matching-Logik)
                If IstAntwortAuf(replyMail.Subject, olMail.Subject) And _
                    replyMail.SentOn >= olMail.SentOn Then
 
                    antwortVorhanden = True
                    ' Verschiebe die E-Mails in den Abgeschlossen-Ordner
                    olMail.Move AbgeschlossenFolder
                    replyMail.Move AbgeschlossenFolder
 
                    ' Füge E-Mail-Adresse zur Antwort-Zusammenfassung hinzu
                    PersonenMitAntwort = PersonenMitAntwort & recipientAddress & vbCrLf
                    Exit For
                End If
            End If
        Next Reply
 
        ' Wenn keine Antwort vorhanden ist, sende eine Erinnerung
        If Not antwortVorhanden Then
            Set ReminderMail = olApp.CreateItem(olMailItem)
            ReminderMail.Subject = "Erinnerung: Bitte senden Sie den Vertrag zurück"
            ReminderMail.Body = "Bitte senden Sie den Vertrag zurück, falls dies noch nicht geschehen ist."
            ReminderMail.To = recipientAddress
            ReminderMail.Send
 
            ' Füge E-Mail-Adresse der Erinnerungsliste hinzu
            PersonenMitErinnerung = PersonenMitErinnerung & recipientAddress & vbCrLf
        End If
    Next i
 
    ' Sende Zusammenfassungs-Mail
    Set ZusammenfassungMail = olApp.CreateItem(olMailItem)
    ZusammenfassungMail.Subject = "Zusammenfassung der Vertrags-Nachverfolgung"
    ZusammenfassungMail.Body = PersonenMitAntwort & vbCrLf & vbCrLf & PersonenMitErinnerung
    ZusammenfassungMail.To = ZUSAMMENFASSUNG_EMPFAENGER
    ZusammenfassungMail.Send
 
    ' Aufräumen
    Set ZusammenfassungMail = Nothing
    Set ReminderMail = Nothing
    Set olMail = Nothing
    Set replyMail = Nothing
    Set ItemsToProcess = Nothing
    Set VertragswesenFolder = Nothing
    Set olApp = Nothing
    Set olNamespace = Nothing
    Set NachverfolgungFolder = Nothing
    Set AbgeschlossenFolder = Nothing
    Set olInbox = Nothing
    
    Exit Sub
    
ErrorHandler:
    MsgBox "Ein Fehler ist aufgetreten: " & Err.Description, vbCritical, "Fehler in VertragErinnerungNachverfolgung"
    ' Aufräumen auch im Fehlerfall
    On Error Resume Next
    Set ZusammenfassungMail = Nothing
    Set ReminderMail = Nothing
    Set olMail = Nothing
    Set replyMail = Nothing
    Set ItemsToProcess = Nothing
    Set VertragswesenFolder = Nothing
    Set olApp = Nothing
    Set olNamespace = Nothing
    Set NachverfolgungFolder = Nothing
    Set AbgeschlossenFolder = Nothing
    Set olInbox = Nothing
End Sub

' Hilfsfunktion: Prüft, ob ein Betreff eine Antwort auf einen anderen Betreff ist
Private Function IstAntwortAuf(ByVal AntwortSubject As String, ByVal OriginalSubject As String) As Boolean
    Dim CleanAntwort As String
    Dim CleanOriginal As String
    
    ' Normalisiere beide Betreffs (Kleinbuchstaben, Leerzeichen entfernen)
    CleanAntwort = LCase(Trim(AntwortSubject))
    CleanOriginal = LCase(Trim(OriginalSubject))
    
    ' Entferne gängige Antwort-Präfixe (re:, aw:, fwd:, wg:)
    CleanAntwort = EntfernePraefixe(CleanAntwort)
    
    ' Prüfe, ob die bereinigten Betreffs übereinstimmen
    IstAntwortAuf = (CleanAntwort = CleanOriginal)
End Function

' Hilfsfunktion: Entfernt Antwort-Präfixe aus dem Betreff
Private Function EntfernePraefixe(ByVal Subject As String) As String
    Dim Result As String
    Dim Changed As Boolean
    
    Result = Trim(Subject)
    
    ' Wiederhole, bis keine Präfixe mehr gefunden werden
    Do
        Changed = False
        
        ' Prüfe auf verschiedene Präfixe (mit Längenvalidierung)
        If Len(Result) >= 3 And Left(Result, 3) = "re:" Then
            Result = Trim(Mid(Result, 4))
            Changed = True
        ElseIf Len(Result) >= 3 And Left(Result, 3) = "aw:" Then
            Result = Trim(Mid(Result, 4))
            Changed = True
        ElseIf Len(Result) >= 4 And Left(Result, 4) = "fwd:" Then
            Result = Trim(Mid(Result, 5))
            Changed = True
        ElseIf Len(Result) >= 3 And Left(Result, 3) = "wg:" Then
            Result = Trim(Mid(Result, 4))
            Changed = True
        End If
    Loop While Changed
    
    EntfernePraefixe = Result
End Function
